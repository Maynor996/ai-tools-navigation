name: è‡ªåŠ¨æ›´æ–°ç«™ç‚¹ä¿¡æ¯

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹è¿è¡Œ (UTC 1:00)
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]

jobs:
  update-site:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        npm install axios cheerio
        
    - name: æ›´æ–°ç«™ç‚¹æ•°æ®
      run: |
        echo "ğŸš€ å¼€å§‹æ£€æµ‹AIå·¥å…·å¹³å°çŠ¶æ€..."
        node scripts/update-tools.js
        
    - name: éªŒè¯æ›´æ–°ç»“æœ
      run: |
        echo "ğŸ“Š æ£€æŸ¥æ›´æ–°ç»“æœ..."
        if [ -f "_data/site_data.json" ]; then
          echo "âœ… æ•°æ®æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          ls -la _data/
        else
          echo "âŒ æ•°æ®æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
        fi
        
        if [ -f "index.md" ]; then
          echo "âœ… ä¸»é¡µæ–‡ä»¶å­˜åœ¨"
          echo "ğŸ“„ æ–‡ä»¶å¤§å°: $(wc -c < index.md) bytes"
        else
          echo "âŒ ä¸»é¡µæ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°å†…å®¹æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
        else
          echo "ğŸ“ æ£€æµ‹åˆ°å†…å®¹æ›´æ–°ï¼Œå‡†å¤‡æäº¤..."
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          AVAILABLE_COUNT=$(node -e "
            try {
              const data = require('.//_data/site_data.json');
              console.log(data.update_info.available_tools || 0);
            } catch(e) {
              console.log('0');
            }
          ")
          TOTAL_COUNT=$(node -e "
            try {
              const data = require('.//_data/site_data.json');
              console.log(data.update_info.tools_checked || 0);
            } catch(e) {
              console.log('0');
            }
          ")
          
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ç«™ç‚¹ä¿¡æ¯

ğŸ“… æ›´æ–°æ—¶é—´: ${CURRENT_TIME}
ğŸ” æ£€æŸ¥å¹³å°: ${TOTAL_COUNT} ä¸ª
âœ… å¯ç”¨å¹³å°: ${AVAILABLE_COUNT} ä¸ª
ğŸ¤– By GitHub Actions"
          
          git push
          echo "âœ… æ›´æ–°å·²æäº¤å¹¶æ¨é€"
        fi

  deploy:
    needs: update-site
    runs-on: ubuntu-latest
    if: success()
    
    permissions:
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: æ£€å‡ºæ›´æ–°åçš„ä»£ç 
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
        
    - name: è®¾ç½® Ruby ç¯å¢ƒ
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: åˆ›å»º Gemfile.lockï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      run: |
        if [ ! -f "Gemfile.lock" ]; then
          echo "åˆ›å»º Gemfile.lock..."
          bundle install
        fi
        
    - name: å®‰è£… Jekyll ä¾èµ–
      run: |
        echo "ğŸ“¦ å®‰è£… Jekyll å’Œç›¸å…³ä¾èµ–..."
        gem install jekyll bundler
        bundle install
        
    - name: éªŒè¯ Jekyll é…ç½®
      run: |
        echo "ğŸ” éªŒè¯ Jekyll é…ç½®..."
        if [ -f "_config.yml" ]; then
          echo "âœ… Jekyll é…ç½®æ–‡ä»¶å­˜åœ¨"
          cat _config.yml | head -10
        else
          echo "âŒ ç¼ºå°‘ Jekyll é…ç½®æ–‡ä»¶"
          exit 1
        fi
        
    - name: æ„å»º Jekyll ç«™ç‚¹
      run: |
        echo "ğŸ—ï¸ æ„å»º Jekyll ç«™ç‚¹..."
        bundle exec jekyll build --destination ./_site --verbose
        
        echo "ğŸ“Š æ„å»ºç»“æœ:"
        ls -la _site/
        echo "ğŸ“„ ç”Ÿæˆçš„æ–‡ä»¶æ•°é‡: $(find _site -type f | wc -l)"
        
    - name: ä¸Šä¼ é¡µé¢èµ„æº
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./_site
        
    - name: éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
      
    - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo "ğŸŒ ç½‘ç«™åœ°å€: ${{ steps.deployment.outputs.page_url }}"
        echo "â° éƒ¨ç½²æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" 